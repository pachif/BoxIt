<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>BoxIt Organizer</title>

    <!-- Bootstrap -->
    <link href="Content/bootstrap.min.css" rel="stylesheet">
    <link href="Content/CustomStyles.css" rel="stylesheet"/>
    <link rel="stylesheet" type="text/css" href="Content/drag.css" />
    <!--<link href="Content/bootstrap-theme.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="fonts/font-awesome-4.2.0/css/font-awesome.min.css" />-->
    
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
	  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.2/html5shiv.js"></script>
	  <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="Scripts/jquery-1.9.1.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="Scripts/bootstrap.min.js"></script>
    <script src="Scripts/boxit-common.js"></script>
    <script src="Scripts/knockout-3.3.0.js"></script>
    <script src="Scripts/knockout-sortable.js"></script>
</head>
<body>
    <nav class="navbar navbar-default" role="navigation">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">BoxIT</a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="#">Your Boxes</a></li>
                    <li><a href="#">Save</a></li>
                </ul>
                <div class="nav navbar-nav navbar-right">
                    <form class="navbar-form navbar-left" role="search">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Search">
                        </div>
                        <button type="submit" class="btn btn-default"><span class="glyphicon glyphicon-search"></span></button>
                    </form>
                </div>

            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>

    <div class="container">
        <div class="jumbotron">
            <h1>Hello, user!</h1>
            <p>This Application will blow your mind</p>
            <p>Besides that is a simple organizer</p>
        </div>
    
        <div class="row">
        
            <div class="col-sm-12">
                <div class="panel panel-default" data-bind="with: mainViewModel">
                    <div class="panel-heading">
                        <span>BoxIt Work Area </span>
                        <div class="pull-right">
                            <button id="addNoteButton" type="button" class="btn btn-default" data-bind="click: addNote">
                                <span class="glyphicon glyphicon-plus" />
                            </button>
                            <button id="trashButton" class="btn btn-default" type="button" data-bind="event: { drop: $root.removeNodeByPosition }">
                                <span class="glyphicon glyphicon-trash" />
                            </button>
                            <button id="boxButton" class="btn btn-default" data-toggle="tooltip" data-placement="top" title="" data-original-title="Add Box" type="button">
                            <span class="glyphicon glyphicon-inbox" />
                            </button>
                            
                        </div>
                        <div class="clearfix"></div>
                    </div>
                    <div id="workAreaBody" class="panel-body drag-container">
                        <!--<div class="col-sm-4">
                            <div class="panel panel-primary boxIt-common">
                                <div class="panel-heading">
                                    <button type="button" class="btn btn-primary btn-xs" onclick="BoxIt.Note.beginEditMode(this)"><span class="glyphicon glyphicon-edit" /></button>
                                    Note 1
                                    <div class="pull-right">
                                        <button type="button" class="btn btn-primary btn-xs"><span class="glyphicon glyphicon-arrow-left"></span></button>
                                        <button type="button" class="btn btn-primary btn-xs"><span class="glyphicon glyphicon-arrow-right"></span></button>
                                    </div>
                                </div>
                                

                                <div class="panel-body">

                                    <p>This is an Example 1</p>
                                    <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit.</p>
                                    <p>This is a Test</p>

                                </div>
                            </div>

                            <div class="panel panel-primary hide">
                                <div class="panel-heading form-inline form-group-sm">
                                    <button class="btn btn-primary btn-sm" onclick="BoxIt.Note.endEditMode(this)"><span class="glyphicon glyphicon-floppy-disk" /></button>
                                    <input type="text" class="form-control" placeholder="Enter your title here" itemscope="" />

                                </div>
                                <div class="panel-body">
                                    <textarea class="form-control" rows="5"> Lorem ipsum dolor sit amet, consectetur adipiscing elit. 
                                        Lorem ipsum dolor sit amet, consectetur adipiscing elit. 
                                        Lorem ipsum dolor sit amet, consectetur adipiscing elit. 
                                        Lorem ipsum dolor sit amet, consectetur adipiscing elit. 
                                    </textarea>
                                </div>
                            </div>
                        </div>-->

                        <div id="koBoxit" data-bind="sortable: { template : 'singleNoteTemplate', data: notes }">
                        </div>

                    </div>
                </div>
            </div>
        
        </div>
    </div>
    <script id="singleNoteTemplate" type="text/html">
        
        <div class="col-sm-4">
            <input type="hidden" data-bind="value: position"/>
            <div class="panel panel-primary boxIt-common" data-bind="visible : isReadMode" 
                draggable="true" ondragstart="drag(event)" ondragend="dragend(event)">
                <div class="panel-heading">
                    <button type="button" class="btn btn-primary btn-xs" data-bind="click: onEdit">
                        <span class="glyphicon glyphicon-edit" />
                    </button>
                    <span data-bind="text: title"></span>
                    <div class="pull-right">
                        <button type="button" class="btn btn-primary btn-xs" data-bind="click: retrocedeNode"><span class="glyphicon glyphicon-arrow-left"></span></button>
                        <button type="button" class="btn btn-primary btn-xs" data-bind="click: advanceNode"><span class="glyphicon glyphicon-arrow-right"></span></button>
                    </div>
                </div>
                <div class="panel-body">

                    <p data-bind="text: note"></p>

                </div>
            </div>
            <div class="panel panel-primary" data-bind="visible : isEditMode">
                <div class="panel-heading form-inline form-group-sm">
                    <button class="btn btn-primary btn-sm" data-bind="click: onSave"><span class="glyphicon glyphicon-floppy-disk" /></button>
                    <input type="text" class="form-control" placeholder="Enter your title here" data-bind="value: title" />

                </div>
                <div class="panel-body">
                    <textarea class="form-control" rows="5" data-bind="value: note"></textarea>
                </div>
            </div>


        </div>

    </script>
    <script type="text/javascript">
        // Using HTML5 native drag&drop API
        function drag(ev) {
            ev.dataTransfer.effectAllowed = 'move';
            var pos = ev.target.parentElement.querySelector('input[type=hidden]').value;
            ev.dataTransfer.setData("text", pos);
            elementDragged = ev.target;
        }

        function dragend(ev) {
            elementDragged = null;
        };
        
        trashButton.addEventListener('dragover', function(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }

            e.dataTransfer.dropEffect = 'move';

            return false;
        });
        //trashButton.addEventListener('drop', function (e) {
        //    if (e.preventDefault) e.preventDefault();
        //    if (e.stopPropagation) e.stopPropagation();

        //    var pos = e.dataTransfer.getData("text");
            
        //    // Remove the element from the list.
        //    //document.getElementById('koBoxit').removeChild(elementDragged);
        //    elementDragged.parentElement.removeChild(elementDragged);
        //    mainViewModel.removeNodeByPosition(pos);
        //    return false;
        //});
    </script>
    <script>
        function boxitNoteViewModel(title,note,position, parentVM) {
            this.title = ko.observable(title);
            this.note = ko.observable(note);
            this.position = ko.observable(position);
            this.parent = ko.observable(parentVM);
            this.isEditMode = ko.observable(false);
            this.isReadMode = ko.computed(function() { return !this.isEditMode(); }, this);
            //this.isReadMode = ko.observable(true);
            this.onEdit = function () {
                this.isEditMode(true);
                //this.isReadMode(false);
            };
            this.onSave = function() {
                this.isEditMode(false);
                //this.isReadMode(true);
            };
            this.advanceNode = function () {
                var pos = this.position();
                var parentNotes = this.parent().notes();
                if (pos < parentNotes.length) {
                    this.position(pos+1);
                    var newpos = parentNotes[pos].position();
                    parentNotes[pos].position(newpos - 1);
                    // Refresh ordered list
                    this.parent().orderNotes();
                }
            };
            this.retrocedeNode = function () {
                var pos = this.position();
                var parentNotes = this.parent().notes();
                if (pos > 1) {
                    this.position(pos-1);
                    var newpos = parentNotes[pos - 2].position();
                    parentNotes[pos - 2].position(newpos + 1);
                    // Refresh ordered list
                    this.parent().orderNotes();
                }
            };
        }

        function mainViewModel() {
            var self = this;
            
            this.owner = ko.observable("Rian");
            this.notes = ko.observableArray(
                [new boxitNoteViewModel("Test 1", "Lorem ipsum dolor sit amet, consectetur adipiscing elit. ", 1, self),
                 new boxitNoteViewModel("Test 2", "Lorem ipsum dolor sit amet, consectetur adipiscing elit. ", 2, self)]
            );
            
            this.addNote = function () {
                var pos = self.notes().length + 1;
                this.notes.push(new boxitNoteViewModel("Title " + pos, "Lorem ipsum dolor sit amet, consectetur adipiscing elit.", pos, self));
            };
            this.removeNodeByPosition = function (data, event) {
                if (!event) { return false; }
                
                var position = event.dataTransfer.getData("text");
                this.notes.remove(function (item) { return item.position == position; });
            };
            this.orderNotes = function () {
                var tempNotes = self.notes();
                tempNotes.sort(function (l, r) {
                    var rightPos = r.position();
                    var leftPos = l.position();
                    //return rightPos == leftPos ? 0 : (leftPos > rightPos ? -1 : 1);
                    return leftPos - rightPos;
                });
                this.notes(tempNotes);
            };
        }

        ko.applyBindings(new mainViewModel());
    </script>
</body>
</html>
